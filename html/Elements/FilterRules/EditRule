<%doc>
Allow a filter rule to be edited.

  FilterRuleGroup - RT::FilterRuleGroup object containing the rules
  FilterRule - RT::FilterRule object for this rule, undef if creating new
  Edit - which type of rule to edit - "GroupRequirements" or "FilterRules"
  PageLink - URL of page this element is on, to post the form to
  Create - if true, show the form to create a new rule
  SetEnabled - if true, the "Enabled" checkbox is on the page

Assumes that $PageLink needs to be passed an "id" parameter of
$FilterRuleGroup->id and a "Rule" parameter of the filter rule ID, to view
or edit a filter rule.
</%doc>
\
<%ARGS>
$FilterRuleGroup => undef
$FilterRule      => undef
$Edit            => 'GroupRequirements'
$PageLink        => undef
$Create          => undef
$SetEnabled      => undef
</%ARGS>
\
<%INIT>
return if ( not $FilterRuleGroup );

my $CanSee    = $FilterRuleGroup->CurrentUserHasRight('SeeFilterRule');
my $CanModify = $FilterRuleGroup->CurrentUserHasRight('ModifyFilterRule');
my $CanCreate = $FilterRuleGroup->CurrentUserHasRight('CreateFilterRule');
my $CanDelete = $FilterRuleGroup->CurrentUserHasRight('DeleteFilterRule');

$CanSee = $CanModify = $CanCreate = $CanDelete = 1
    if ( $session{'CurrentUser'}
    ->HasRight( Right => 'SuperUser', Object => RT->System ) );

my $EnabledChecked = 'checked="checked"';

if ( ( not $Create ) && $FilterRule && $FilterRule->id ) {
    $EnabledChecked = '' if ( $FilterRule->Disabled );
} elsif ( $SetEnabled && ( not $ARGS{'Enabled'} ) ) {
    $EnabledChecked = '';
}

my %VisibleCustomFields = ();
my %StatusValues        = ();

foreach my $QueueCollection (
    $FilterRuleGroup->CanMatchQueuesObj,
    $FilterRuleGroup->CanTransferQueuesObj
    )
{
    while ( my $QueueObj = $QueueCollection->Next ) {
        my $TicketCustomFields = $QueueObj->TicketCustomFields;
        while ( my $CustomField = $TicketCustomFields->Next ) {
            $VisibleCustomFields{ $CustomField->Name } = $CustomField->id;
        }
        $StatusValues{$_} = 1 foreach ( $QueueObj->LifecycleObj->Valid );
    }
}
</%INIT>

<p>
<form action="<%$PageLink%>" method="post">
<input type="hidden" name="id" value="<%$FilterRuleGroup->id%>" />
<p>
<input type="submit" value="&larr; <&|/l&>Back</&>" />
</p>
</form>

% return
%     if ( ( not defined $FilterRule )
%     && ( not $Create ) );

<form action="<%$PageLink%>" method="post">
<input type="hidden" name="id" value="<%$FilterRuleGroup->id%>" />
<input type="hidden" name="Rule" value="<% $Create ? 'new' : $FilterRule->id%>" />
<input type="hidden" name="ModifyRule" value="1" />
\
<table>
<tr>\
<th style="text-align:right;"><&|/l&>Name</&>:</th>\
<td>\
% if ($CanModify || $CanCreate) {
<input name="Name" required value="<% $Create ? '' : $FilterRule->Name || $ARGS{'Name'} %>" />\
% } else {
<% $FilterRule->Name %>\
% }
</td>\
</tr>
<tr>\
% if ($CanModify || $CanCreate) {
<td style="text-align:right;"><input type="checkbox" class="checkbox" id="Enabled" name="Enabled" value="1" <%$EnabledChecked|n%> /></td>\
<td><label for="Enabled">\
%     if ($Edit eq 'GroupRequirements') {
<&|/l&>Enabled (Unchecking this box disables this requirement rule)</&>\
%     } else {
<&|/l&>Enabled (Unchecking this box disables this filter rule)</&>\
%     }
</label><br />\
<input type="hidden" class="hidden" name="SetEnabled" value="1" />\
</td>\
% } else {
<th style="text-align:right;"><&|/l&>Status</&>:</th><td><% $FilterRule->Disabled ? loc('Disabled') : loc('Enabled') %></td>\
% }
</tr>
<tr>\
<th style="text-align:right;"><&|/l&>Trigger type</&>:</th>\
<td>\
% my $TriggerTypeValue = $Create ? '' : $FilterRule->TriggerType || $ARGS{'TriggerType'};
% if ($CanModify || $CanCreate) {
<select id="TriggerType" name="TriggerType">\
<option value="Create"<% $TriggerTypeValue eq 'Create'?' selected':'' %>><&|/l&>On ticket creation</&></option>\
<option value="QueueMove"<% $TriggerTypeValue eq 'QueueMove'?' selected':'' %>><&|/l&>When a ticket moves between queues</&></option>\
</select>\
% } elsif ($TriggerTypeValue eq 'Create') {
<&|/l&>On ticket creation</&>\
% } elsif ($TriggerTypeValue eq 'QueueMove') {
<&|/l&>When a ticket moves between queues</&>\
% } else {
<% $TriggerTypeValue %>\
% }
</td>\
</tr>
\
<tr><td colspan="2"><hr /></td></tr>
<tr>\
<th style="text-align:right;vertical-align:top;">\
<&|/l&>Requirement conditions</&>:<br />\
<small><em><&|/l&>Rule must meet all of these</&></em></small>\
</th>\
<td style="vertical-align:top;" class="FilterRules FilterRuleConditions FilterRuleRequirements">\
% if ($CanModify || $CanCreate) {
<table>
<tr emptymarker><td colspan="3"><em><&|/l&>No requirement conditions - rule will never match</&></em></td></tr>
</table>
<button type="button" action="AddCondition"><&|/l&>Add condition</&></button>
% } else {
<% $FilterRule->DescribeRequirements |n%>\
% }
</td>\
</tr>
\
<tr><td colspan="2"><hr /></td></tr>
<tr>\
<th style="text-align:right;vertical-align:top;">\
<&|/l&>Conflict conditions</&>:<br />\
<small><em><&|/l&>Rule must not meet any of these</&></em></small>\
</th>\
<td style="vertical-align:top;" class="FilterRules FilterRuleConditions FilterRuleConflicts">\
% if ($CanModify || $CanCreate) {
<table>
<tr emptymarker><td colspan="3"><em><&|/l&>No conflict conditions - rule will match if requirements are met</&></em></td></tr>
</table>
<button type="button" action="AddCondition"><&|/l&>Add condition</&></button>
% } else {
<% $FilterRule->DescribeConflicts |n%>\
% }
</td>\
</tr>
\
% if ($Edit ne 'GroupRequirements') {
<tr><td colspan="2"><hr /></td></tr>
<tr>\
<th style="text-align:right;vertical-align:top;">\
<&|/l&>Actions</&>:<br />\
<small><em><&|/l&>Actions to perform when rule matches</&></em></small>\
</th>\
<td style="vertical-align:top;" class="FilterRules FilterRuleActions">\
% if ($CanModify || $CanCreate) {
<table>
<tr emptymarker><td colspan="3"><em><&|/l&>No actions defined</&></em></td></tr>
</table>
<button type="button" action="AddAction"><&|/l&>Add action</&></button>
% } else {
<% $FilterRule->DescribeActions |n%>\
% }
</td>\
</tr>
% }
\
<tr><td colspan="2"><hr /></td></tr>
<tr>\
<th style="text-align:right;"><&|/l&>Stop if matched</&>:</th>\
<td>\
% if ($CanModify || $CanCreate) {
<select name="StopIfMatched">\
<option value="0"<% ( $Create ? $ARGS{'StopIfMatched'} : $FilterRule->StopIfMatched ) ? '' : ' selected' %>>\
<&|/l&>No - continue processing remaining rules if this rule matches</&>\
</option>\
<option value="1"<% ( $Create ? $ARGS{'StopIfMatched'} : $FilterRule->StopIfMatched ) ? ' selected' : '' %>>\
<&|/l&>Yes - stop processing remaining rules if this rule matches</&>\
</option>\
</select>\
% } elsif ($FilterRule->StopIfMatched) {
<&|/l&>Yes - stop processing remaining rules if this rule matches</&>\
% } else {
<&|/l&>No - continue processing remaining rules if this rule matches</&>\
% }
</td>\
</tr>
\
% if ($CanModify || $CanCreate) {
<tr>\
<td colspan="2"><hr />\
%     if ( $Create ) {
<& /Elements/Submit, Label => loc('Create') &>
%     } else {
<& /Elements/Submit, Label => loc('Save Changes') &>
%     }
</td></tr>
% }
</table>
</form>
\
% if ($CanCreate || $CanModify) {
\
%#   Hidden drop-down lists to use when constructing the form.
\
<span style="display:none;">
\
<select id="ConditionTypes">
%     foreach ( RT::Extension::FilterRules->ConditionTypes( $session{'CurrentUser'} ) ) {
<option\
 value="<% $_->{'ConditionType'} %>"\
 triggertypes="<% join (',', @{$_->{'TriggerTypes'}}) %>"\
 valuetype="<% $_->{'ValueType'} %>"\
><% $_->{'Name'} %></option>
%     }
</select>
\
<select id="ActionTypes">
%     foreach ( RT::Extension::FilterRules->ActionTypes( $session{'CurrentUser'} ) ) {
<option\
 value="<% $_->{'ActionType'} %>"\
 valuetype="<% $_->{'ValueType'} %>"\
><% $_->{'Name'} %></option>
%     }
</select>
\
<select id="CanMatchQueues">
<option value="">-</option>
%     my ($Collection, $Item);
%     $Collection = $FilterRuleGroup->CanMatchQueuesObj;
%     $Collection->OrderByCols( { 'FIELD' => 'Name', 'ORDER' => 'ASC' } );
%     while ($Item = $Collection->Next) {
<option value="<% $Item->id %>"><% $Item->Name %></option>
%     }
</select>
\
<select id="CanTransferQueues">
<option value="">-</option>
%     $Collection = $FilterRuleGroup->CanTransferQueuesObj;
%     $Collection->OrderByCols( { 'FIELD' => 'Name', 'ORDER' => 'ASC' } );
%     while ($Item = $Collection->Next) {
<option value="<% $Item->id %>"><% $Item->Name %></option>
%     }
</select>
\
<select id="CanUseGroups">
<option value="">-</option>
%     $Collection = $FilterRuleGroup->CanUseGroupsObj;
%     $Collection->OrderByCols( { 'FIELD' => 'Name', 'ORDER' => 'ASC' } );
%     while ($Item = $Collection->Next) {
<option value="<% $Item->id %>"><% $Item->Name %></option>
%     }
</select>
\
<select id="CustomFields">
<option value="">-</option>
%     foreach (sort keys %VisibleCustomFields) {
<option value="<% $VisibleCustomFields{$_} %>"><% $_ %></option>
%     }
</select>
\
<select id="Statuses">
<option value="">-</option>
%     foreach (sort keys %StatusValues) {
<option><% $_ %></option>
%     }
</select>
\
</span>
\
<script type="text/javascript">
\
var countFilterRuleFields = 0;
var countFilterRuleFieldValues = 0;
\
function addFilterRuleCondition (setCF, setType, setText, setQueue, setStatus) {
    var newRow = jQuery('<tr></tr>');
    var cellType = jQuery('<td></td>');
    var cellValue = jQuery('<td></td>');
    var cellButton = jQuery('<td></td>');
    var typePrefix = jQuery('<em></em>');
    var typeCF = jQuery('<select></select>');
    var typeType = jQuery('<select></select>');
    var valueText = jQuery('<input />');
    var valueQueue = jQuery('<select></select>');
    var valueStatus = jQuery('<select></select>');

    countFilterRuleFields++;

    var conditionSet = 'Requirements';
    if (jQuery(this).parents('td[FilterRules]').first().hasClass('FilterRuleConflicts'))
        conditionSet = 'Conflicts';

    if (conditionSet == 'Requirements') {
        typePrefix.text(<%loc('AND')|j%>+' ');
    } else {
        typePrefix.text(<%loc('OR')|j%>+' ');
    }

    typeCF.html(jQuery('#CustomFields').html());
    typeCF.attr('name', conditionSet+'-'+countFilterRuleFields+'-CustomField');
    typeCF.attr('typecf', 1);
    if (setCF)
        typeCF.val(setCF);

    typeType.html(jQuery('#ConditionTypes').html());
    typeType.attr('name', conditionSet+'-'+countFilterRuleFields+'-ConditionType');
    typeType.attr('settype', 1);
    if (setType)
        typeType.val(setType);

    valueText.attr('type', 'text');
    valueText.attr('size', '30');
    valueText.attr('name', conditionSet+'-'+countFilterRuleFields+'-ValueText-0');
    valueText.attr('textvalue', 1);
    if (setText)
        valueText.val(setText);

    valueQueue.html(jQuery('#CanMatchQueues').html());
    valueQueue.attr('name', conditionSet+'-'+countFilterRuleFields+'-ValueQueue-0');
    valueQueue.attr('queuevalue', 1);
    if (setQueue)
        valueQueue.val(setQueue);

    valueStatus.html(jQuery('#Statuses').html());
    valueStatus.attr('name', conditionSet+'-'+countFilterRuleFields+'-ValueStatus-0');
    valueStatus.attr('statusvalue', 1);
    if (setStatus)
        valueStatus.val(setStatus);

    cellType.append(typePrefix);
    cellType.append(typeCF);
    cellType.append(typeType);
    cellType.css('vertical-align', 'top');

    cellValue.attr('valuecell', 1);
    cellValue.append(valueText);
    cellValue.append(valueQueue);
    cellValue.append(valueStatus);
    cellValue.append('<br />');
    cellValue.append('<button action="AddValue">'+<%loc('Add value')|j%>+'</button>');

    cellButton.append('<button action="RemoveCondition">'+<%loc('Remove condition')|j%>+'</button>');
    cellButton.css('vertical-align', 'top');

    newRow.append(cellType);
    newRow.append(cellValue);
    newRow.append(cellButton);
    newRow.attr('conditionrow', countFilterRuleFields);

    jQuery(this).parents('td').first().find('table tr[emptymarker]').hide();
    jQuery(this).parents('td').first().find('table').append(newRow);
    jQuery(this).parents('td').first().find('table').find('tr[conditionrow='+countFilterRuleFields+'] select[settype]').on('change', onFilterRuleConditionTypeChange);
    jQuery(this).parents('td').first().find('table').find('tr[conditionrow='+countFilterRuleFields+'] select[settype]').trigger('change');
    jQuery(this).parents('td').first().find('table').find('tr[conditionrow='+countFilterRuleFields+'] button').on('click', onFilterRuleConditionButton);

    onTriggerTypeChange();
    removeFirstLineTypePrefixes(jQuery(this).parents('td').first().find('table'));
}
\
function onFilterRuleConditionTypeChange () {
    var myRow = jQuery(this).parents('tr').first();
    var selectedOption = myRow.find('select[settype] option:selected');

    if (selectedOption.attr('valuetype') == 'Queue') {
        myRow.find('td[valuecell] button').show();
        myRow.find('input[textvalue]').hide();
        myRow.find('input[textvalue]').prop('required', false);
        myRow.find('select[queuevalue]').show();
        myRow.find('select[queuevalue]').prop('required', true);
        myRow.find('select[statusvalue]').hide();
        myRow.find('select[statusvalue]').prop('required', false);
    } else if (selectedOption.attr('valuetype') == 'Status') {
        myRow.find('td[valuecell] button').show();
        myRow.find('input[textvalue]').hide();
        myRow.find('input[textvalue]').prop('required', false);
        myRow.find('select[queuevalue]').hide();
        myRow.find('select[queuevalue]').prop('required', false);
        myRow.find('select[statusvalue]').show();
        myRow.find('select[statusvalue]').prop('required', true);
    } else if (selectedOption.attr('valuetype') == 'None') {
        myRow.find('td[valuecell] button').hide();
        myRow.find('input[textvalue]').hide();
        myRow.find('input[textvalue]').prop('required', false);
        myRow.find('select[queuevalue]').hide();
        myRow.find('select[queuevalue]').prop('required', false);
        myRow.find('select[statusvalue]').hide();
        myRow.find('select[statusvalue]').prop('required', false);
    } else {
        myRow.find('td[valuecell] button').show();
        if (selectedOption.attr('valuetype') == 'Integer') {
            myRow.find('input[textvalue]').attr('size', 4);
        } else {
            myRow.find('input[textvalue]').attr('size', 30);
        }
        myRow.find('input[textvalue]').show();
        myRow.find('input[textvalue]').prop('required', true);
        myRow.find('select[queuevalue]').hide();
        myRow.find('select[queuevalue]').prop('required', false);
        myRow.find('select[statusvalue]').hide();
        myRow.find('select[statusvalue]').prop('required', false);
    }

    if (/CustomField/.test(selectedOption.attr('value'))) {
        myRow.find('select[typecf]').show();
    } else {
        myRow.find('select[typecf]').hide();
    }
}
\
function onFilterRuleConditionButton () {
    var action = jQuery(this).attr('action');
    if (action == 'AddValue') {
       filterRuleConditionAddValue(jQuery(this));
    } else if (action == 'RemoveValue') {
       filterRuleConditionRemoveValue(jQuery(this));
    } else if (action == 'RemoveCondition') {
       filterRuleConditionRemoveCondition(jQuery(this));
    }
    return false;
}
\
function filterRuleConditionAddValue (buttonElement, setText, setQueue, setStatus) {
    var valuePrefix = jQuery('<span></span>');
    var valueText = jQuery('<input />');
    var valueQueue = jQuery('<select></select>');
    var valueStatus = jQuery('<select></select>');
    var thisCell = buttonElement.parents('td').first();
    var fieldNumber = buttonElement.parents('tr').first().attr('conditionrow');

    countFilterRuleFieldValues++;

    var conditionSet = 'Requirements';
    if (buttonElement.parents('td[FilterRules]').first().hasClass('FilterRuleConflicts'))
        conditionSet = 'Conflicts';

    valuePrefix.append(' <em>'+<%loc('OR')|j%>+'</em> ');
    valuePrefix.attr('valuenumber', countFilterRuleFieldValues);

    valueText.attr('type', 'text');
    valueText.attr('size', '30');
    valueText.attr('name', conditionSet+'-'+fieldNumber+'-ValueText-'+countFilterRuleFieldValues);
    valueText.attr('textvalue', 1);
    valueText.attr('valuenumber', countFilterRuleFieldValues);
    if (setText)
        valueText.val(setText);

    valueQueue.html(jQuery('#CanMatchQueues').html());
    valueQueue.attr('name', conditionSet+'-'+fieldNumber+'-ValueQueue-'+countFilterRuleFieldValues);
    valueQueue.attr('queuevalue', 1);
    valueQueue.attr('valuenumber', countFilterRuleFieldValues);
    if (setQueue)
        valueQueue.val(setQueue);

    valueStatus.html(jQuery('#Statuses').html());
    valueStatus.attr('name', conditionSet+'-'+countFilterRuleFields+'-ValueStatus-0');
    valueStatus.attr('statusvalue', 1);
    valueStatus.attr('valuenumber', countFilterRuleFieldValues);
    if (setStatus)
        valueStatus.val(setStatus);

    thisCell.append(valuePrefix);
    thisCell.append(valueText);
    thisCell.append(valueQueue);
    thisCell.append(valueStatus);
    thisCell.append('<br valuenumber='+countFilterRuleFieldValues+' />');
    thisCell.append('<button action="AddValue">'+<%loc('Add value')|j%>+'</button>');

    buttonElement.text(<%loc('Remove value')|j%>);
    buttonElement.attr('action', 'RemoveValue');
    buttonElement.attr('valuenumber', countFilterRuleFieldValues);

    thisCell.find('button').off('click');
    thisCell.find('button').on('click', onFilterRuleConditionButton);
    buttonElement.parents('tr').first().find('select[settype]').trigger('change');
}
\
function filterRuleConditionRemoveValue (buttonElement) {
    var valueNumber = buttonElement.attr('valuenumber');
    buttonElement.parents('table').first().find('[valuenumber='+valueNumber+']').remove();
}
\
function filterRuleConditionRemoveCondition (buttonElement) {
    if (!confirm(<%loc('Remove this condition - are you sure?')|j%>))
        return;
    var myTable = buttonElement.parents('table').first();
    buttonElement.parents('tr').first().remove();
    if (myTable.find('tr').length < 2) {
        myTable.find('tr[emptymarker]').show();
    }
    removeFirstLineTypePrefixes(myTable);
}
\
function removeFirstLineTypePrefixes(table) {
    table.find('tr[conditionrow]').first().find('td > em').remove();
}
\
function addFilterRuleAction () {
// TODO: functions to add filter rule actions
}
\
function onTriggerTypeChange () {
    var triggerType = jQuery('#TriggerType').val();
    jQuery('select[settype] option').each(function () {
        if (jQuery(this).attr('triggertypes').includes(triggerType)) {
            jQuery(this).prop('disabled', false);
        } else {
            jQuery(this).prop('disabled', true);
        }
    });
}
\
jQuery(function () {
    jQuery('button[action=AddCondition]').on('click', addFilterRuleCondition);
    jQuery('button[action=AddAction]').on('click', addFilterRuleAction);
    jQuery('#TriggerType').on('change', onTriggerTypeChange);
\
%# TODO: pre-populate the requirements
%# TODO: pre-populate the conflicts
%# TODO: pre-populate the actions
\
});
</script>
% }
\
% if ( $CanDelete && not $Create ) {
<div style="text-align:right;margin-top:4em;">
<form action="<%$PageLink%>" method="post">
<input type="hidden" name="id" value="<% $FilterRuleGroup->id %>" />
<input type="hidden" name="Rule" value="<% $FilterRule->id %>" />
<div class="error" style="padding:0;display:inline-block;"><div class="error" style="padding:1em;border:solid #400 1px;text-align:left;display:inline-block;">
<input type="submit" name="Delete" value="<&|/l&>Delete this filter rule</&>" />
<br />
<small><input type="checkbox" name="ConfirmDelete" value="1" /> <&|/l&>Check this box to confirm</&></small>
</div></div>
</form>
</div>
% }
\
% if ($FilterRule && $FilterRule->id) {
<& /Elements/ShowHistory,
    Object => $FilterRule,
    ShowDisplayModes => 0,
    DisplayPath => $PageLink,
&>
% }

<%method Post>
<%doc>
Handle form submission to the rule editor, by creating, modifying, or
deleting a rule as appropriate.
</%doc>
\
<%ARGS>
$ARGSRef         => {}
$FilterRuleGroup => undef
$Edit            => 'GroupRequirements'
$Results         => []
</%ARGS>
\
<%INIT>
return if ( not $FilterRuleGroup );
return if ( $ARGSRef->{'Create'} );
return if ( $ARGSRef->{'ModifyRule'} && ( not $ARGSRef->{'Rule'} ) );

my $CanSee    = $FilterRuleGroup->CurrentUserHasRight('SeeFilterRule');
my $CanModify = $FilterRuleGroup->CurrentUserHasRight('ModifyFilterRule');
my $CanCreate = $FilterRuleGroup->CurrentUserHasRight('CreateFilterRule');
my $CanDelete = $FilterRuleGroup->CurrentUserHasRight('DeleteFilterRule');

$CanSee = $CanModify = $CanCreate = $CanDelete = 1
    if ( $session{'CurrentUser'}
    ->HasRight( Right => 'SuperUser', Object => RT->System ) );

# Load the filter rule we're going to need, if modifying / moving
#
my $FilterRule = undef;
my $LoadRule   = undef;
if ( $ARGSRef->{'ModifyRule'} && ( $ARGSRef->{'Rule'} ne 'new' ) ) {
    $LoadRule = $ARGSRef->{'Rule'};
} elsif ( $ARGSRef->{'Delete'} && $ARGSRef->{'Rule'} ) {
    $LoadRule = $ARGSRef->{'Rule'};
} elsif ( $ARGSRef->{'MoveUp'} ) {
    $LoadRule = $ARGSRef->{'MoveUp'};
} elsif ( $ARGSRef->{'MoveDown'} ) {
    $LoadRule = $ARGSRef->{'MoveDown'};
}
if ($LoadRule) {
    $FilterRule = RT::FilterRule->new( $session{'CurrentUser'} );
    if ( not $FilterRule->Load($LoadRule) ) {
        push @$Results, loc( 'Failed to load filter rule [_1]', $LoadRule );
        return;
    }
    if ( $FilterRule->FilterRuleGroupObj->id != $FilterRuleGroup->id ) {
        push @$Results,
            loc( 'Filter rule [_1] is not part of filter rule group [_2]',
            $LoadRule, $FilterRuleGroup->id );
        return;
    }

    if ( $Edit eq 'GroupRequirements' ) {
        if ( not $FilterRule->IsGroupRequirement ) {
            push @$Results,
                loc(
                'Filter rule [_1] is not a requirement rule of filter rule group [_2]',
                $LoadRule, $FilterRuleGroup->id
                );
            return;
        }
    } else {
        if ( $FilterRule->IsGroupRequirement ) {
            push @$Results,
                loc(
                'Filter rule [_1] is not a filter rule of filter rule group [_2]',
                $LoadRule, $FilterRuleGroup->id
                );
            return;
        }
    }
}

if (   $FilterRule
    && $FilterRule->id
    && $ARGSRef->{'Delete'}
    && not $ARGSRef->{'ConfirmDelete'} )
{
    push @$Results, loc('Not deleted - confirmation box not checked');
    return;
} elsif ( $FilterRule
    && $FilterRule->id
    && $ARGSRef->{'Delete'}
    && $ARGSRef->{'ConfirmDelete'}
    && not $CanDelete )
{
    push @$Results, loc('Permission denied');
    return;
} elsif ( $FilterRule
    && $FilterRule->id
    && $ARGSRef->{'Delete'}
    && $ARGSRef->{'ConfirmDelete'} )
{
    my ( $ok, $msg ) = $FilterRule->Delete();
    push @$Results, $msg;
    if ($ok) {
        $ARGSRef->{'Create'} = 1;
        delete $ARGSRef->{'Rule'};
    }
    return;
}

if (   $ARGSRef->{'ModifyRule'}
    && ( $ARGSRef->{'Rule'} eq 'new' )
    && not $CanCreate )
{
    push @$Results, loc('Permission denied');
    return;
} elsif ( $ARGSRef->{'ModifyRule'} && ( $ARGSRef->{'Rule'} eq 'new' ) ) {

    # Create a new filter rule.
    #
    if ( not $CanCreate ) {
        push @$Results, loc('Permission denied');
        $ARGSRef->{'Create'} = 1;
        return;
    }

    my %CreateArgs = (
        'Name'          => $ARGSRef->{'Name'},
        'TriggerType'   => $ARGSRef->{'TriggerType'},
        'StopIfMatched' => $ARGSRef->{'StopIfMatched'} ? 1 : 0,
        'Conflicts'     => [],
        'Requirements'  => [],
        'Actions'       => [],
        'Disabled'      => $ARGSRef->{'Enabled'} ? 0 : 1,
    );

    # TODO: parse conflicts, requirements, and actions

    my ( $ok, $msg );

    if ( $Edit eq 'GroupRequirements' ) {
        ( $ok, $msg ) = $FilterRuleGroup->AddGroupRequirement(%CreateArgs);
    } else {
        ( $ok, $msg ) = $FilterRuleGroup->AddFilterRule(%CreateArgs);
    }
    if ($ok) {
        $ARGSRef->{'Rule'} = $ok;
    } else {
        $ARGSRef->{'Create'} = 1;
    }
    push @$Results, $msg;

} elsif ( $ARGSRef->{'ModifyRule'} && not $CanModify ) {
    push @$Results, loc('Permission denied');
    return;
} elsif ( $ARGSRef->{'MoveUp'} && not $CanModify ) {
    push @$Results, loc('Permission denied');
    return;
} elsif ( $ARGSRef->{'MoveDown'} && not $CanModify ) {
    push @$Results, loc('Permission denied');
    return;
} elsif ( $ARGSRef->{'ModifyRule'} ) {

    # Modify an existing filter rule.
    #
    my @Attributes = qw(Name TriggerType StopIfMatched Disabled);

    $ARGSRef->{'Disabled'} = $ARGSRef->{'Enabled'} ? 0 : 1;

    push @$Results,
        UpdateRecordObject(
        AttributesRef => \@Attributes,
        Object        => $FilterRule,
        ARGSRef       => $ARGSRef
        );

    # TODO: modify rule conflicts, requirements, actions

} elsif ( $ARGSRef->{'MoveUp'} ) {

    # Move an existing filter rule up.
    #
    my ( $ok, $msg ) = $FilterRule->MoveUp;
    push @$Results, $msg;

} elsif ( $ARGSRef->{'MoveDown'} ) {

    # Move an existing filter rule down.
    #
    my ( $ok, $msg ) = $FilterRule->MoveDown;
    push @$Results, $msg;
}

return;
</%INIT>
</%method>
